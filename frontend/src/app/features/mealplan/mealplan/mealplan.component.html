@if (!loading()) {
  <section class="mx-auto max-w-7xl px-4 py-8">
    <div class="flex items-center gap-2 flex-wrap text-left">
      <h1
        class="text-2xl font-bold tracking-tight text-gray-900 leading-tight wrap-break-word"
      >
        @if (plan(); as p) {
          Meal Plan for week {{ p.createdAt | date: 'longDate' }}
        } @else {
          Meal Plan
        }
      </h1>

      @if (plan(); as p) {
        <app-source-tag [source]="p.source"/>
      }
    </div>

    <div
      class="mb-3 mt-3 flex flex-col md:flex-row flex-wrap items-start md:items-center justify-start gap-3"
    >
      <div
        class="flex flex-wrap items-center gap-3 justify-start md:ml-auto md:justify-end"
      >
        @if (!mealPlanIdSignal()) {
          <button
            (click)="onGenerate()"
            [attr.aria-busy]="loading()"
            [disabled]="loading()"
            class="rounded-xl border px-4 py-2 font-medium shadow disabled:opacity-60
            hover:bg-gray-50 transition-colors hover:cursor-pointer"
            data-testid="btn-generate"
            type="button"
          >
            {{ loading() ? 'Generating…' : 'Generate meal plan' }}
          </button>
        }

        @if (plan(); as plan) {
          <button
            (click)="onDownloadShoppingListPdf(plan.id)"
            [attr.aria-busy]="downloadingShoppingListPdf()"
            [disabled]="downloadingShoppingListPdf()"
            aria-label="Download shopping list as PDF"
            class="flex items-center gap-2 rounded-xl px-4 py-2 font-medium
            shadow disabled:opacity-60 bg-emerald-600 text-white hover:bg-emerald-700
            transition-colors hover:cursor-pointer"
            data-testid="btn-download-shopping-list"
            title="Download shopping list as PDF"
            type="button"
          >
            <i class="fa-solid fa-file-arrow-down"></i>
            {{ downloadingShoppingListPdf() ? 'Downloading' : 'Shopping List' }}
            @if (downloadingShoppingListPdf()) {
              <i class="fa-solid fa-spinner fa-spin"></i>
            }
          </button>

          <button
            (click)="onDownloadMealPlanPdf(plan.id)"
            [attr.aria-busy]="downloadingMealPlanPdf()"
            [disabled]="downloadingMealPlanPdf()"
            aria-label="Download meal plan as PDF"
            class="flex items-center gap-2 rounded-xl px-4 py-2 font-medium
            shadow disabled:opacity-60 bg-emerald-600 text-white hover:bg-emerald-700
            transition-colors hover:cursor-pointer"
            data-testid="btn-download-meal-plan"
            title="Download meal plan as PDF"
            type="button"
          >
            <i class="fa-solid fa-file-arrow-down"></i>
            {{ downloadingMealPlanPdf() ? 'Downloading' : 'Meal plan' }}
            @if (downloadingMealPlanPdf()) {
              <i class="fa-solid fa-spinner fa-spin"></i>
            }
          </button>
        }
      </div>
    </div>

    @if (errorMessage()) {
      <app-error-message [message]="errorMessage()!" data-testid="error-message"></app-error-message>
    }
    @if (!plan() && !loading() && !errorMessage()) {
      <p>
        @if (!plan()) {
          Meal plan not found or failed to load.
        } @else {
          Click “Generate meal plan” to create your personalized plan.
        }
      </p>
    }
    @if (plan()) {
      @if (totalWeeks() > 1) {
        <p class="mt-2 text-sm text-gray-600">
          Showing week
          <span class="font-medium text-emerald-800">{{ currentWeekIndex() + 1 }}</span>
          of
          <span class="font-medium text-emerald-800">{{ totalWeeks() }}</span>
        </p>
      }

      <nav
        aria-label="Week days"
        class="flex items-center gap-2 rounded-xl bg-gray-100 p-1.5"
        role="tablist"
      >
        @if (totalWeeks() > 1) {
          <button
            (click)="previousWeek()"
            [class]="weekButtonClasses"
            [disabled]="!canNavigateToPreviousWeek()"
            aria-label="Previous week"
            type="button"
          >
            <i class="fa-solid fa-arrow-left"></i>
          </button>
        }
        @for (day of visibleDays(); track day.dayOfWeek; let i = $index) {
          @let absoluteIndex = weekStart() + i;
          <button
            (click)="selectDay(absoluteIndex)"
            [attr.aria-controls]="'day-panel-' + absoluteIndex"
            [attr.aria-selected]="selectedDayIndex() === absoluteIndex"
            [attr.data-testid]="'day-tab-' + absoluteIndex"
            [class]="dayButtonClasses(absoluteIndex)"
            [id]="'day-tab-' + absoluteIndex"
            class="flex-1 whitespace-nowrap rounded-lg px-3 py-1.5
               text-center text-sm font-medium transition-all hover:cursor-pointer"
            role="tab"
            type="button"
          >
              <span class="lg:hidden">
                {{ day.dayOfWeek | titlecase | slice: 0:2 }}
              </span>
            <span class="hidden lg:inline">
                {{ day.dayOfWeek | titlecase }}
              </span>
          </button>
        }
        @if (totalWeeks() > 1) {
          <button
            (click)="nextWeek()"
            [class]="weekButtonClasses"
            [disabled]="!canNavigateToNextWeek()"
            aria-label="Next week"
            type="button"
          >
            <i class="fa-solid fa-arrow-right"></i>
          </button>
        }
      </nav>

      <div
        [attr.aria-labelledby]="'day-tab-' + selectedDayIndex()"
        [id]="'day-panel-' + selectedDayIndex()"
        class="mt-8 grid grid-cols-1 gap-6
        lg:grid-cols-[2.6fr_1.0fr] xl:grid-cols-[2.8fr_1.0fr]"
        role="tabpanel"
        tabindex="0"
      >
        <div class="flex flex-col gap-8 self-start">
          <app-daily-meal-plan-totals
            [dailyTargets]="dailyTargets()"
            [dailyTotals]="dailyTotals()"
            data-testid="daily-totals"
          />

          <app-daily-meal-plan
            (toggleRecipe)="onToggleRecipe($event)"
            [dailyPlan]="selectedDay()"
            [expandedRecipeIds]="expandedRecipeIds()"
            [recipeDetails]="recipeDetails()"
            [recipeMacrosMap]="recipeMacrosMap()"
          />
        </div>

        <app-meal-plan-shopping-list
          (toggleItem)="onToggleShoppingListItem($event)"
          [error]="shoppingListError()"
          [loading]="shoppingListLoading()"
          [shoppingList]="shoppingList()"
          [updatingItemId]="updatingShoppingListItemId()"
          class="self-start"
          data-testid="shopping-list"
        />
      </div>
    }
  </section>
} @else {
  @if (loadingMessage()) {
    <app-loading-message [message]="loadingMessage()" data-testid="loading-message"/>
  } @else {
    <app-loading-message data-testid="loading-message"/>
  }
}
