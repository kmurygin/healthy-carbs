@if (dailyPlan()) {
  <main class="space-y-8 lg:col-span-2">

    <h3 class="mb-3 text-xl font-bold text-gray-900 flex items-center gap-2" id="mealplan-hdr">
      <i class="fa-solid fa-bowl-food text-emerald-600"></i>
      Meal plan
    </h3>

    @for (group of groupedByMealType(); track group.mealType) {
      <section [attr.aria-labelledby]="'hdr-' + group.mealType">
        <div class="flex items-center gap-3">
          <h3
            [id]="'hdr-' + group.mealType"
            class="text-xl font-bold text-gray-800 flex items-center gap-2"
          >
            {{ group.mealType }}
          </h3>
          <hr class="w-full flex-1 border-gray-200"/>
        </div>

        <ul class="mt-4 grid grid-cols-1 gap-4 list-none pl-0 ml-0">
          @for (mealPlanRecipe of group.items; track mealPlanRecipe.id) {
            <li
              class="rounded-xl border bg-white shadow-sm border-gray-200"
            >
              <button
                (click)="onToggleRecipe(mealPlanRecipe.recipe.id)"
                [attr.aria-controls]="'panel-' + mealPlanRecipe.recipe.id"
                [attr.aria-expanded]="expandedRecipeIds().has(mealPlanRecipe.recipe.id)"
                class="group block w-full rounded-t-xl px-0 py-4 text-left focus-visible:outline-none
                focus-visible:ring-2 focus-visible:ring-emerald-500 hover:bg-gray-50
                hover:cursor-pointer"
                type="button"
              >

                <div
                  class="flex items-start justify-between gap-2 px-4"
                >
                  <div class="min-w-0 text-left flex flex-col">
                    <h4
                      [id]="'hdr-recipe-' + mealPlanRecipe.recipe.id"
                      class="text-lg font-semibold text-gray-900 flex items-center gap-2"
                    >
                      {{ mealPlanRecipe.recipe.name }}
                    </h4>

                    @if (mealPlanRecipe.recipe.description) {
                      <p class="mt-1 text-sm text-gray-600 line-clamp-2">
                        {{ mealPlanRecipe.recipe.description }}
                      </p>
                    }
                  </div>

                  <div class="text-right flex-shrink-0">
                    @let macros = recipeMacrosMap().get(mealPlanRecipe.recipe.id);

                    <p class="text-sm text-gray-500 whitespace-nowrap">
                      <span class="inline-flex items-center gap-1">
                        <i class="fa-solid fa-bread-slice text-amber-600"></i>
                        {{ macros?.carbs ?? 0 }} g
                      </span>
                      <span class="mx-1">·</span>
                      <span class="inline-flex items-center gap-1">
                        <i class="fa-solid fa-drumstick-bite text-red-500"></i>
                        {{ macros?.protein ?? 0 }} g
                      </span>
                      <span class="mx-1">·</span>
                      <span class="inline-flex items-center gap-1">
                        <i class="fa-solid fa-bottle-droplet text-yellow-600"></i>
                        {{ macros?.fat ?? 0 }} g
                      </span>
                    </p>

                    <p class="text-lg font-semibold flex items-center justify-end gap-1">
                      <i class="fa-solid fa-fire text-orange-500"></i>
                      {{ macros?.calories ?? 0 | number: '1.0-0' }} kcal
                    </p>
                  </div>
                </div>
              </button>

              @if (expandedRecipeIds().has(mealPlanRecipe.recipe.id)) {
                <div
                  [attr.aria-labelledby]="'hdr-recipe-' + mealPlanRecipe.recipe.id"
                  [id]="'panel-' + mealPlanRecipe.recipe.id"
                  class="overflow-hidden rounded-b-xl border-t border-gray-200"
                  role="region"
                >
                  @if (recipeDetails().has(mealPlanRecipe.recipe.id)) {
                    @let details = recipeDetails().get(mealPlanRecipe.recipe.id);

                    <div class="p-4">

                      <div class="mb-4 flex flex-wrap gap-2">
                        <span [class]="dietTagClasses(mealPlanRecipe.recipe.dietType)">
                          <i class="fa-solid fa-leaf text-xs"></i>
                          {{ mealPlanRecipe.recipe.dietType }}
                        </span>
                      </div>

                      <div class="grid grid-cols-1 md:grid-cols-5 gap-8">

                        <div class="md:col-span-2">
                          <h5 class="font-semibold text-gray-900 flex items-center gap-2">
                            <i class="fa-solid fa-carrot text-gray-400"></i>
                            Ingredients
                          </h5>
                          <div class="mt-2">
                            <ul class="space-y-1 text-base list-none pl-0 ml-0">
                              @for (recipeIngredient of details!.ingredients; track recipeIngredient.id) {
                                <li class="flex justify-between items-baseline gap-4 py-1 border-b border-gray-100">
                                  <span class="text-gray-800">
                                    {{ recipeIngredient.ingredient.name }}
                                  </span>
                                  <span class="text-gray-600 text-right flex-shrink-0">
                                    {{ recipeIngredient.quantity | number: '1.0-2' }}
                                    @if (recipeIngredient.ingredient.unit) {
                                      {{ recipeIngredient.ingredient.unit }}s
                                    } @else {
                                      items
                                    }
                                  </span>
                                </li>
                              }
                            </ul>
                          </div>
                        </div>

                        @if (details?.instructions) {
                          <div class="md:col-span-3">
                            <h5 class="font-semibold text-gray-900 flex items-center gap-2">
                              <i class="fa-solid fa-list-check text-gray-400"></i>
                              Instructions
                            </h5>
                            <ol class="list-decimal marker:text-emerald-700 ms-5 space-y-1 mt-2">
                              @for (step of parseInstructions(details?.instructions); track $index) {
                                <li class="text-gray-700 leading-relaxed">{{ step }}</li>
                              }
                            </ol>
                          </div>
                        }
                      </div>
                    </div>
                  } @else {
                    <div class="p-4 text-center text-sm text-gray-500">
                      <i class="fa-solid fa-spinner fa-spin text-emerald-600 mr-1"></i>
                      Loading details…
                    </div>
                  }
                </div>
              }
            </li>
          }
        </ul>
      </section>
    }
  </main>
}
